default:
  image: python:3.8-slim-buster

stages:
  - lint
  - test

variables:
  POETRY_VERSION: 1.2.2
  DESIGN_SPEC: designs/explore_cube.yaml

before_script:
  - pip install -qq "poetry==$POETRY_VERSION"
  # Beware the tokens: https://github.com/python-poetry/poetry/issues/2889
  - poetry config -- http-basic.gitlab gitlab-ci-token "$CI_JOB_TOKEN"
  - poetry install

lint-python:
  stage: lint
  needs: [ ]
  script:
    # Run all the linting in a sensible order
    - poetry run isort --check src tests
    - poetry run black --check src tests
    - poetry run flake8 src tests
    - poetry run mypy

test-python:
  stage: test
  needs: [ ]
  script:
    - poetry run pytest

test-design-file-runs:
  stage: test
  needs: [ ]
  script:
    - poetry run explorer run --fabric src $DESIGN_SPEC

test-design-files-compile:
  stage: test
  needs: [ ]
  script:
    - for f in designs/*.yaml; do poetry run explorer compile --fabric src $f; done
